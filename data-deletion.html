<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Effici Data Deletion Requests</title>
    <style>
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #1a1f2c;
            --muted: #586074;
            --primary: #1f4fd6;
            --danger: #b42318;
            --border: #d9deea;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #eef3ff 0%, var(--bg) 35%);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            width: min(860px, 94vw);
            margin: 2rem auto 4rem;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 12px 36px rgba(28, 42, 79, 0.08);
            margin-bottom: 1rem;
        }

        h1, h2, h3 { line-height: 1.25; margin: 0 0 0.75rem; }
        h1 { font-size: 1.85rem; }
        h2 { font-size: 1.2rem; margin-top: 1rem; }
        h3 { font-size: 1.05rem; margin-top: 1rem; }

        p, li, td, th, label { color: var(--muted); }
        ul { padding-left: 1.2rem; margin: 0.5rem 0 0; }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.9rem;
        }

        .btn {
            border: 0;
            border-radius: 10px;
            padding: 0.72rem 1rem;
            background: var(--primary);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn.secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .form-grid {
            display: grid;
            gap: 0.8rem;
            margin-top: 0.8rem;
        }

        .row {
            display: grid;
            gap: 0.6rem;
        }

        @media (min-width: 700px) {
            .row.two {
                grid-template-columns: 1fr 1fr;
            }
        }

        input[type="email"], input[type="date"] {
            width: 100%;
            padding: 0.72rem 0.82rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 1rem;
            color: var(--text);
        }

        .radio {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem;
        }

        .radio label {
            display: flex;
            gap: 0.55rem;
            align-items: flex-start;
            color: var(--text);
        }

        .note {
            border-left: 4px solid var(--primary);
            padding: 0.75rem 0.85rem;
            background: #f3f6ff;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .status {
            margin-top: 0.8rem;
            min-height: 1.2rem;
            font-weight: 600;
            color: #165d1f;
        }

        .error {
            margin-top: 0.3rem;
            min-height: 1.2rem;
            color: var(--danger);
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.8rem;
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.65rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            color: var(--text);
            background: #f7f9ff;
        }

        code {
            background: #f2f4f8;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.1rem 0.4rem;
            color: #364055;
        }
    </style>
</head>
<body>
<main class="container">
    <section class="card">
        <h1>Effici Data Deletion Requests</h1>
        <p>
            This page belongs to the <strong>Effici</strong> app and is the data deletion request URL shown on Google Play.
        </p>
        <ul>
            <li>Use this page to request data deletion with secure email verification.</li>
            <li>You can delete all app data while keeping your account, or delete session data for a date range.</li>
            <li>If you want account + all data deleted, use the account deletion flow below.</li>
        </ul>
    </section>

    <section class="card">
        <h2>Request deletion while keeping your account</h2>
        <p>Step 1: Choose what to delete and send yourself a secure confirmation link.</p>

        <div class="form-grid">
            <div>
                <label for="email"><strong>Effici account email</strong></label>
                <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required>
            </div>

            <div class="radio">
                <label>
                    <input type="radio" name="deletion-scope" value="all_keep_account" checked>
                    <span>
                        <strong>Delete all productivity data, keep account</strong><br>
                        Sessions, distractions, projects, tags, daily stats, timer configs.
                    </span>
                </label>
            </div>

            <div class="radio">
                <label>
                    <input type="radio" name="deletion-scope" value="sessions_range">
                    <span>
                        <strong>Delete session data for a date range, keep account</strong><br>
                        Deletes sessions/distractions and daily stats for the selected range.
                    </span>
                </label>
            </div>

            <div id="range-fields" class="row two" style="display: none;">
                <div>
                    <label for="start-date">Start date</label>
                    <input id="start-date" type="date">
                </div>
                <div>
                    <label for="end-date">End date</label>
                    <input id="end-date" type="date">
                </div>
            </div>

            <div>
                <button id="send-link-btn" type="button" class="btn">Send Secure Deletion Link</button>
                <div id="status" class="status"></div>
                <div id="error" class="error"></div>
            </div>
        </div>

        <p class="note">
            For security, deletion is only executed after opening the email link and confirming on the next page.
        </p>
    </section>

    <section class="card">
        <h2>Delete account and all data</h2>
        <p>
            If you want to permanently remove your Effici account itself (not only app data), use this flow:
        </p>
        <div class="actions">
            <a class="btn secondary" href="account-deletion.html">Open account deletion flow</a>
        </div>
    </section>

    <section class="card">
        <h2>What gets deleted or retained</h2>
        <table>
            <thead>
            <tr>
                <th>Data type</th>
                <th>Deleted</th>
                <th>Retention notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>Productivity data (sessions, distractions, projects, tags, daily stats, timer configs)</td>
                <td>Deleted based on the option you select.</td>
                <td>Backups and operational logs may persist temporarily, typically up to 30 days.</td>
            </tr>
            <tr>
                <td>Effici auth account and profile</td>
                <td>Deleted only in the account deletion flow.</td>
                <td>May be retained only if required for legal/security reasons.</td>
            </tr>
            <tr>
                <td>Billing transactions (Google Play)</td>
                <td>Not deleted by Effici systems.</td>
                <td>Managed by Google Play under legal/accounting requirements.</td>
            </tr>
            </tbody>
        </table>
    </section>

    <section class="card">
        <h3>Need help?</h3>
        <p>
            If you cannot access your email, contact support at <code>whynkay@gmail.com</code> and include your Effici account email.
        </p>
    </section>
</main>

<script type="module">
    const DELETE_LINK_ENDPOINT = "https://gddeglmchwqxesqqncif.supabase.co/functions/v1/send-deletion-link";

    const emailInput = document.getElementById("email");
    const rangeFields = document.getElementById("range-fields");
    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");
    const sendLinkBtn = document.getElementById("send-link-btn");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    function setStatus(message = "", isError = false) {
        if (isError) {
            errorEl.textContent = message;
            statusEl.textContent = "";
            return;
        }
        statusEl.textContent = message;
        errorEl.textContent = "";
    }

    function selectedScope() {
        const checked = document.querySelector('input[name="deletion-scope"]:checked');
        return checked ? checked.value : "all_keep_account";
    }

    function isConfigured() {
        return DELETE_LINK_ENDPOINT.startsWith("https://");
    }

    function validateInputs(scope) {
        const email = emailInput.value.trim();
        if (!email) {
            return { ok: false, message: "Email is required." };
        }
        if (scope === "sessions_range") {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (!startDate || !endDate) {
                return { ok: false, message: "Start date and end date are required for range deletion." };
            }
            if (endDate < startDate) {
                return { ok: false, message: "End date must be on or after start date." };
            }
        }
        return { ok: true };
    }

    function onScopeChanged() {
        const scope = selectedScope();
        rangeFields.style.display = scope === "sessions_range" ? "grid" : "none";
    }

    document.querySelectorAll('input[name="deletion-scope"]').forEach((radio) => {
        radio.addEventListener("change", onScopeChanged);
    });
    onScopeChanged();

    sendLinkBtn.addEventListener("click", async () => {
        const scope = selectedScope();
        const validation = validateInputs(scope);
        if (!validation.ok) {
            setStatus(validation.message, true);
            return;
        }
        if (!isConfigured()) {
            setStatus("Page is not configured yet. Set DELETE_LINK_ENDPOINT.", true);
            return;
        }

        sendLinkBtn.disabled = true;
        setStatus("Sending secure confirmation link...");

        try {
            const response = await fetch(DELETE_LINK_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    flow: "data",
                    email: emailInput.value.trim(),
                    scope,
                    start_date: scope === "sessions_range" ? startDateInput.value : null,
                    end_date: scope === "sessions_range" ? endDateInput.value : null
                })
            });

            if (!response.ok) {
                setStatus("Unable to send deletion link right now. Please try again.", true);
                return;
            }

            setStatus("If this email is registered, a secure deletion confirmation link has been sent.");
        } catch (error) {
            setStatus("Unable to send deletion link right now. Please check your internet connection and try again.", true);
        } finally {
            sendLinkBtn.disabled = false;
        }
    });
</script>
<script src="assets/build-meta.js"></script>
<script src="assets/build-footer.js" defer></script>
</body>
</html>
