<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Confirm Data Deletion - Effici</title>
    <style>
        :root {
            color-scheme: light;
            --bg: #f6f7fb;
            --card: #fff;
            --text: #1c2333;
            --muted: #5a6278;
            --danger: #b42318;
            --danger-bg: #ffeceb;
            --ok: #166534;
            --border: #d9deea;
            --primary: #1f4fd6;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(1200px 500px at 20% -10%, #e7edff 0%, transparent 65%), var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            width: min(760px, 92vw);
            margin: 2rem auto 4rem;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 12px 36px rgba(28, 42, 79, 0.08);
        }

        h1 { margin: 0 0 0.8rem; line-height: 1.25; }
        p { color: var(--muted); margin: 0.5rem 0; }

        .danger-box {
            border: 1px solid #ffd6d2;
            background: var(--danger-bg);
            border-radius: 12px;
            padding: 0.9rem;
            margin: 1rem 0;
        }

        .danger-box strong { color: var(--danger); }

        .summary {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem;
            margin-top: 0.6rem;
            background: #fbfcff;
        }

        button {
            border: 0;
            border-radius: 10px;
            padding: 0.74rem 1rem;
            background: var(--primary);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .status {
            margin-top: 0.8rem;
            min-height: 1.2rem;
            font-weight: 600;
            color: var(--ok);
        }

        .error {
            margin-top: 0.8rem;
            min-height: 1.2rem;
            color: var(--danger);
            font-weight: 600;
        }

        code {
            background: #f2f4f8;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.1rem 0.4rem;
        }
    </style>
</head>
<body>
<main class="container">
    <section class="card">
        <h1>Confirm Data Deletion</h1>
        <p id="intro-text">Validating your secure deletion link...</p>
        <p id="signed-in-email"></p>

        <div class="summary" id="request-summary"></div>

        <div class="danger-box">
            <strong>This action is permanent.</strong>
            <p>
                The selected Effici data will be removed from your account and cannot be restored.
            </p>
        </div>

        <button id="delete-btn" type="button" disabled>Confirm Data Deletion</button>
        <div id="status" class="status"></div>
        <div id="error" class="error"></div>
    </section>
</main>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.57.4";

    const SUPABASE_URL = "https://gddeglmchwqxesqqncif.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_FDB4Y8z7HrCaA8aeeaBSAg_iYBsHX2v";

    const introEl = document.getElementById("intro-text");
    const emailEl = document.getElementById("signed-in-email");
    const summaryEl = document.getElementById("request-summary");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const deleteBtn = document.getElementById("delete-btn");

    function setStatus(message = "", isError = false) {
        if (isError) {
            errorEl.textContent = message;
            statusEl.textContent = "";
            return;
        }
        statusEl.textContent = message;
        errorEl.textContent = "";
    }

    function isConfigured() {
        return (
            SUPABASE_URL.startsWith("https://") &&
            SUPABASE_ANON_KEY &&
            !SUPABASE_URL.includes("YOUR_PROJECT_REF") &&
            !SUPABASE_ANON_KEY.includes("YOUR_SUPABASE_ANON_KEY")
        );
    }

    function parseDeletionRequest() {
        const params = new URLSearchParams(window.location.search);
        const scope = params.get("scope") || "all_keep_account";
        const startDate = params.get("start_date");
        const endDate = params.get("end_date");

        if (!["all_keep_account", "sessions_range"].includes(scope)) {
            throw new Error("Invalid deletion scope in link.");
        }

        if (scope === "sessions_range") {
            if (!startDate || !endDate) {
                throw new Error("This deletion link is missing date range details.");
            }
            if (endDate < startDate) {
                throw new Error("Invalid date range in deletion link.");
            }
        }

        return { scope, startDate, endDate };
    }

    function clearAuthParamsFromUrl(request) {
        const cleanUrl = new URL(window.location.href);
        cleanUrl.search = "";
        cleanUrl.hash = "";
        cleanUrl.searchParams.set("scope", request.scope);
        if (request.scope === "sessions_range") {
            cleanUrl.searchParams.set("start_date", request.startDate);
            cleanUrl.searchParams.set("end_date", request.endDate);
        }
        window.history.replaceState({}, document.title, cleanUrl.toString());
    }

    async function establishSession(supabase, request) {
        const query = new URLSearchParams(window.location.search);
        const hash = new URLSearchParams(window.location.hash.replace(/^#/, ""));
        const code = query.get("code");
        const accessToken = hash.get("access_token");
        const refreshToken = hash.get("refresh_token");

        if (code) {
            const { error } = await supabase.auth.exchangeCodeForSession(code);
            if (error) throw error;
            clearAuthParamsFromUrl(request);
        } else if (accessToken && refreshToken) {
            const { error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
            });
            if (error) throw error;
            clearAuthParamsFromUrl(request);
        }

        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;
        if (!data.session) {
            throw new Error("Invalid or expired link. Request a new deletion link.");
        }
        return data.session;
    }

    function renderRequestSummary(request) {
        if (request.scope === "all_keep_account") {
            summaryEl.innerHTML = "<strong>Requested action:</strong> Delete all productivity data while keeping this Effici account.";
            return;
        }

        summaryEl.innerHTML =
            "<strong>Requested action:</strong> Delete session data for date range " +
            `<code>${request.startDate}</code> to <code>${request.endDate}</code> while keeping this Effici account.`;
    }

    function payloadForRpc(request) {
        if (request.scope === "sessions_range") {
            return {
                p_scope: request.scope,
                p_start_date: request.startDate,
                p_end_date: request.endDate
            };
        }
        return { p_scope: request.scope };
    }

    function formatRpcResult(data) {
        if (!data || typeof data !== "object") {
            return "Deletion completed.";
        }

        const parts = [];
        if (typeof data.deleted_sessions === "number") {
            parts.push(`${data.deleted_sessions} sessions`);
        }
        if (typeof data.deleted_projects === "number") {
            parts.push(`${data.deleted_projects} projects`);
        }
        if (typeof data.deleted_tags === "number") {
            parts.push(`${data.deleted_tags} tags`);
        }
        if (typeof data.deleted_daily_stats === "number") {
            parts.push(`${data.deleted_daily_stats} daily stats rows`);
        }
        if (typeof data.deleted_timer_configs === "number") {
            parts.push(`${data.deleted_timer_configs} timer config rows`);
        }
        if (parts.length === 0) {
            return "Deletion completed.";
        }
        return `Deletion completed: ${parts.join(", ")}.`;
    }

    async function init() {
        if (!isConfigured()) {
            introEl.textContent = "Page is not configured yet.";
            setStatus("Set SUPABASE_URL and SUPABASE_ANON_KEY before use.", true);
            return;
        }

        let request;
        try {
            request = parseDeletionRequest();
            renderRequestSummary(request);
        } catch (error) {
            introEl.textContent = "Invalid deletion link.";
            setStatus(error?.message ?? "Link validation failed.", true);
            return;
        }

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        try {
            const session = await establishSession(supabase, request);
            introEl.textContent = "Link verified. Confirm this data deletion request for:";
            emailEl.textContent = session.user?.email ?? "";
            deleteBtn.disabled = false;
        } catch (error) {
            introEl.textContent = "Could not verify your deletion link.";
            setStatus(error?.message ?? "Unable to verify link.", true);
            return;
        }

        deleteBtn.addEventListener("click", async () => {
            deleteBtn.disabled = true;
            setStatus("Deleting requested data...");

            try {
                const { data, error } = await supabase.rpc("delete_my_app_data", payloadForRpc(request));
                if (error) throw error;

                setStatus(formatRpcResult(data));
                introEl.textContent = "Data deletion completed.";
                summaryEl.innerHTML = "";
                emailEl.textContent = "";
            } catch (error) {
                setStatus(error?.message ?? "Failed to delete data.", true);
                deleteBtn.disabled = false;
            }
        });
    }

    init();
</script>
<script src="assets/build-meta.js"></script>
<script src="assets/build-footer.js" defer></script>
</body>
</html>
